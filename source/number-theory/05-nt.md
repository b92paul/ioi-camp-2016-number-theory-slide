# 循環節

##
整數在$\mod{m}$下是一個元素有限的集合，又寫作$\mathbb{Z}_m$。

所以當一個整數$a$，把他的所有次方$1, a, a^2, a^3 \cdots$列出來，
因為這數列可以無限的下去，鴿籠原理告訴你說一定存在兩個不同的$i,j$，其中$i<j, a^i \equiv a^j \mod{m}$，對於任意大於等於$i$的整數$k$

> $a^k \equiv a^{k-i}a^{i} \equiv a^{k-i}a^{j}$
>
> $\equiv a^{k +(j-i)} \mod{m}$

##
因此對任意這樣的$k$來說，
任何正整數$m$都會讓下面等式滿足，

> $a^{k} \equiv a^{k+ m\times(j-i)} \mod{m}$

這時候其實我們就找到了所謂的循環節！

> Recall: 費馬小定理 或是 尤拉定理

##有趣的結論

1. 最短循環節的長度一定是$\varphi(m)$的因數！

- 這...不好說啊

2. 再來是只要從$1, a, a^2, a^3, a^4...$找下去，

	我們可以用map去記錄看過的數字

	在$O(\log{m} +\varphi(m))$的時間內一定會找到最短的循環節，

##
簡單的解釋$\log{m}$的存在，
一開始不一定會出現循環節的原因，
其實是因為那些$a$與$m$之間共有的質因數。

如果那些質因數在$a^i$次方夠大時超過了$m$裡面同樣質因數的次方數，
那該質因數對於mod就不再會有影響，
所以約莫要花上$\log{m}$的時間來做到這件事。


##
這兩個結論告訴我們，
通常可以很放心的直接一個個跑下去找循環節，
很快就會找到。
很重要的是循環節通常會用兩個數字表示:

1. 一個代表從哪個次方會開始循環。

2. 一個代表循環節長度。

## 次方次方

> 給定正整數$a_1, a_2 ,a_3$，
> 再給定一個數字$m$，
> 
> 請問$a_1^{a_2^{a_3}} \bmod{m}$ 的答案應該要是多少?



## Solution

- 如果$a_1$與$m$互質，我們可以很簡單的用尤拉定理，
- 因為${a_1}^{\varphi(m)}\equiv 1 \mod{m}$，

	所以可以讓$t\equiv{a_2}^{a_3} \mod{\varphi(m)}$，

- 然後就可以直接用${a_i}^t$算出答案。

- 但如果不互質的話，

	我們其實可以去跑$a_1$在$m$中的起點與循環節，

	假設起點是$k$循環節是$r$。


## 要先判斷大小，

1. 如果${a_2}^{a_3} < k$我們直接去計算答案就好，

	因為$k$不會太大。

2. 如果${a_2}^{a_3} \ge k$

	那我們其實可以去計算$t \equiv {a_2}^{a_3}-k \mod{r}$，

	那答案就是$a^k \times a^t \mod{m}$。

## 好寫的小技巧

對於 $a^k \equiv x \mod{m}$

- 訂個上限 $len$
- 如果 $k <= len$ 就直接算 $a^k \mod{m}$
- 如果 $k > len$

	$k \equiv k' \mod{phi(m)}$
	
	就算 $a^{k' + phi(m)}$
